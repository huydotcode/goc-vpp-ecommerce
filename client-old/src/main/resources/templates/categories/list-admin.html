<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Categories</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <script th:src="@{/js/api.js}"></script>
    <script th:src="@{/js/lib.js}"></script>
    <script th:src="@{/js/entity-manager.js}"></script>
    <script th:src="@{/js/image-upload-manager.js}"></script>
    <script th:src="@{/js/categories.js}"></script>
</head>
<body>
    <div th:replace="~{layouts/admin :: adminLayout(~{::section}, 'Quản lý Categories', 'categories')}">
        <section>
            <div class="admin-card">
                <div class="admin-card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0;"><i class="fas fa-list"></i> Danh sách Categories</h4>
                        <button type="button" class="btn btn-primary" onclick="showCreateCategoryModal()">
                            <i class="fas fa-plus"></i> Thêm Category
                        </button>
                    </div>
                </div>
                <div class="admin-card-body">

                        <!-- Filter Form -->
                        <form id="filterForm" class="mb-4" th:action="@{/categories}" method="get">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div class="form-group">
                                    <label for="id"><i class="fas fa-hashtag" style="margin-right:6px;"></i>ID:</label>
                                    <input type="text" id="id" name="id" class="form-control" th:value="${id}" placeholder="Tìm theo ID...">
                                </div>
                                <div class="form-group">
                                    <label for="name"><i class="fas fa-tag" style="margin-right:6px;"></i>Tên:</label>
                                    <input type="text" id="name" name="name" class="form-control" th:value="${name}" placeholder="Tìm theo tên...">
                                </div>
                                <div class="form-group">
                                    <label for="isActive"><i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái:</label>
                                    <select id="isActive" name="isActive" class="form-control">
                                        <option value="" th:selected="${isActive == null}">Tất cả</option>
                                        <option value="true" th:selected="${isActive == true}">Active</option>
                                        <option value="false" th:selected="${isActive == false}">Inactive</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="search"><i class="fas fa-search" style="margin-right:6px;"></i>Tìm kiếm:</label>
                                    <input type="text" id="search" name="search" class="form-control" th:value="${search}" placeholder="Nhập tên, mô tả hoặc id.">
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Lọc
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetCategoriesFilters()">
                                    <i class="fas fa-times"></i> Xóa bộ lọc
                                </button>
                            </div>
                        </form>

                        <!-- Table Loading Overlay -->
                        <div class="table-loading-overlay" id="tableLoadingOverlay">
                            <div class="loading-spinner"></div>
                        </div>

                        <!-- Notification Container -->
                        <div id="notificationContainer"></div>
                        
                        <!-- Flash Messages -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>
                        <a class="text-decoration-none"
                           th:href="@{/categories(page=${currentPage}, size=${size}, sort='id', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">
                            <i class="fas fa-hashtag" style="margin-right:6px;"></i>ID
                            <i th:if="${sort == 'id'}" th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                        </a>
                    </th>
                    <th>
                        <a class="text-decoration-none"
                           th:href="@{/categories(page=${currentPage}, size=${size}, sort='name', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">
                            <i class="fas fa-tag" style="margin-right:6px;"></i>Tên
                            <i th:if="${sort == 'name'}" th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                        </a>
                    </th>
                    <th><i class="fas fa-image" style="margin-right:6px;"></i>Thumbnail</th>
                    <th><i class="fas fa-align-left" style="margin-right:6px;"></i>Mô tả</th>
                    <th>
                        <a class="text-decoration-none"
                           th:href="@{/categories(page=${currentPage}, size=${size}, sort='isActive', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">
                            <i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái
                            <i th:if="${sort == 'isActive'}" th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                        </a>
                    </th>
                    <th class="text-center"><i class="fas fa-ellipsis-h" style="margin-right:6px;"></i>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="c : ${categories}" th:attr="data-cate-id=${c.id}">
                    <td th:text="${c.id}"></td>
                    <!-- Name -->
                    <td>
                        <span class="cell-view" th:text="${c.name}"></span>
                        <input class="cell-edit form-control" style="display:none;" th:attr="data-field='name'" th:value="${c.name}" />
                    </td>
                    <!-- Thumbnail -->
                    <td>
                        <span class="cell-view">
                            <img th:if="${c.thumbnailUrl}" th:src="${c.thumbnailUrl}" alt="thumb" 
                                 class="clickable-image" 
                                 th:attr="data-image-url=${c.thumbnailUrl}"
                                 style="width:48px;height:48px;object-fit:cover;border-radius:4px;cursor:pointer;"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect fill=\'%23e6e6e6\' width=\'48\' height=\'48\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'10\'%3ENo Image%3C/text%3E%3C/svg%3E'; this.classList.add('img-error');"/>
                            <span th:if="${c.thumbnailUrl == null || c.thumbnailUrl.isEmpty()}">-</span>
                        </span>
                        <div class="cell-edit" style="display:none;">
                            <div class="upload-url-input-container">
                                <input class="form-control upload-url-input" th:attr="data-field='thumbnailUrl'" th:value="${c.thumbnailUrl}" placeholder="Thumbnail URL" />
                            </div>
                            <div class="inline-upload-area" th:attr="data-category-id=${c.id}" onclick="triggerFileInput(this)">
                                <i class="fas fa-cloud-upload-alt inline-upload-icon"></i>
                                <div class="inline-upload-text">Kéo thả ảnh hoặc click để chọn</div>
                                <div class="inline-upload-hint">JPG, PNG, WEBP, AVIF - tối đa 5MB</div>
                                <input type="file" class="upload-area-file-input" accept="image/jpeg,image/png,image/webp,image/avif" 
                                       th:id="'thumbnailUrlFile' + ${c.id}" th:attr="data-category-id=${c.id}, onchange='handleThumbnailUpload(this, ' + ${c.id} + ')'" />
                            </div>
                            <div class="upload-preview-container"></div>
                        </div>
                    </td>
                    <!-- Description -->
                    <td>
                        <span class="cell-view" th:text="${c.description}"></span>
                        <input class="cell-edit form-control" style="display:none;" th:attr="data-field='description'" th:value="${c.description}" placeholder="Mô tả" />
                    </td>
                    <!-- Active -->
                    <td>
                        <span class="cell-view">
                            <span th:if="${c.isActive}" class="badge bg-success">Active</span>
                            <span th:unless="${c.isActive}" class="badge bg-danger">Inactive</span>
                        </span>
                        <select class="cell-edit form-control" style="display:none;" th:attr="data-field='isActive'">
                            <option value="true" th:selected="${c.isActive}">Active</option>
                            <option value="false" th:selected="${!c.isActive}">Inactive</option>
                        </select>
                    </td>
                    <!-- Actions -->
                    <td class="text-center">
                        <div class="cell-view">
                            <button type="button" class="btn btn-info btn-sm" title="Xem" th:onclick="'viewCategory(' + ${c.id} + ')'">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-warning btn-sm" title="Sửa" th:onclick="'enterCategoryEditMode(' + ${c.id} + ')'">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div class="cell-edit" style="display:none;">
                            <button type="button" class="btn btn-success btn-sm" th:onclick="'saveInlineCategory(' + ${c.id} + ')'">Lưu</button>
                            <button type="button" class="btn btn-secondary btn-sm" th:onclick="'cancelCategoryEditMode(' + ${c.id} + ')'">Hủy</button>
                        </div>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(categories)}">
                    <td colspan="6">Không có dữ liệu</td>
                </tr>
            </tbody>
        </table>
                        </div>

        <!-- Page Size Selector -->
        <div class="page-size-selector">
            <label for="pageSize">Hiển thị:</label>
            <select id="pageSize" name="pageSize" onchange="changePageSize()">
                <option value="5" th:selected="${size == 5}">5</option>
                <option value="10" th:selected="${size == 10}">10</option>
                <option value="20" th:selected="${size == 20}">20</option>
                <option value="50" th:selected="${size == 50}">50</option>
                <option value="100" th:selected="${size == 100}">100</option>
            </select>
            <span>kết quả/trang</span>
        </div>

        <div class="pagination">
            <a th:if="${hasPrev}" th:href="@{/categories(page=${currentPage - 1}, size=${size}, sort=${sort}, direction=${direction}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}"><i class="fas fa-chevron-left"></i> Trước</a>
            <span th:text="${currentPage} + ' / ' + ${totalPages}"></span>
            <a th:if="${hasNext}" th:href="@{/categories(page=${currentPage + 1}, size=${size}, sort=${sort}, direction=${direction}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">Tiếp <i class="fas fa-chevron-right"></i></a>
                </div>
            </div>
        </section>
            </div>

            <!-- Create Category Modal -->
            <div id="createCategoryModal" class="modal" data-static="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Thêm Category</h3>
                        <button class="modal-close" onclick="closeModal('createCategoryModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="createCategoryForm" th:action="@{/categories}" method="post">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="createCateName">Tên *</label>
                                    <input id="createCateName" class="form-control" type="text" name="name" required />
                                    <div class="error-message" id="createCateNameError"></div>
                                </div>
                                <div class="form-group">
                                    <label for="createThumbnailUrl">Thumbnail</label>
                                    <div class="upload-url-input-container">
                                        <input id="createThumbnailUrl" class="form-control upload-url-input" type="text" name="thumbnailUrl" placeholder="Nhập URL ảnh hoặc upload bên dưới" />
                                    </div>
                                    <div class="upload-area" onclick="triggerFileInput(this)" data-create-mode="true">
                                        <i class="fas fa-cloud-upload-alt upload-area-icon"></i>
                                        <div class="upload-area-text">Kéo thả ảnh vào đây hoặc click để chọn</div>
                                        <div class="upload-area-hint">JPG, PNG, WEBP, AVIF - tối đa 5MB</div>
                                        <input type="file" id="createThumbnailUrlFile" class="upload-area-file-input" accept="image/jpeg,image/png,image/webp,image/avif" onchange="handleThumbnailUpload(this)" />
                                    </div>
                                    <div class="upload-progress-container" id="createCategoryProgressContainer">
                                        <div class="upload-progress-label">
                                            <span>Đang upload ảnh...</span>
                                            <span class="upload-progress-percent">0%</span>
                                        </div>
                                        <div class="upload-progress-bar">
                                            <div class="upload-progress-fill"></div>
                                        </div>
                                    </div>
                                    <div id="createThumbnailUrlPreviewContainer" class="upload-preview-container"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="createCateDesc">Mô tả</label>
                                <input id="createCateDesc" class="form-control" type="text" name="description" />
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('createCategoryModal')">Hủy</button>
                        <button type="button" class="btn btn-primary" onclick="submitCreateCategory()">Thêm</button>
                    </div>
                </div>
            </div>

            <!-- Drawer detail for Category -->
            <div id="cateDrawer" class="drawer">
                <div class="drawer-panel">
                    <div class="drawer-header">
                        <h3 class="drawer-title"><i class="fas fa-tag" style="margin-right:8px;"></i>Chi tiết Category</h3>
                        <button class="modal-close" onclick="closeDrawer('cateDrawer')">&times;</button>
                    </div>
                    <div class="drawer-body">
                        <div class="desc-section">
                            <h4 class="desc-section-title">Thông tin cơ bản</h4>
                            <div class="desc-grid">
                                <div class="desc-label">ID</div><div class="desc-value" id="viewCateId">-</div>
                                <div class="desc-label">Tên</div><div class="desc-value" id="viewCateName">-</div>
                                <div class="desc-label">Trạng thái</div><div class="desc-value" id="viewCateIsActive">-</div>
                            </div>
                        </div>
                        <div class="desc-section">
                            <h4 class="desc-section-title">Hiển thị</h4>
                            <div class="desc-grid">
                                <div class="desc-label">Thumbnail</div><div class="desc-value"><img id="viewCateThumbnail" class="thumb-lg clickable-image" alt="thumb" style="display:none;cursor:pointer;" /></div>
                                <div class="desc-label">Mô tả</div><div class="desc-value" id="viewCateDescription">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="drawer-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeDrawer('cateDrawer')">Đóng</button>
                    </div>
                </div>
            </div>

        </section>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="image-preview-modal">
        <div class="image-preview-content">
            <button class="image-preview-close" onclick="closeImagePreview()">&times;</button>
            <img id="previewImage" src="" alt="Preview" />
        </div>
    </div>
    
    <script>
        // Ensure functions are globally available
        window.showImagePreview = function(imageUrl) {
            console.log('showImagePreview called with:', imageUrl);
            
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('previewImage');
            
            console.log('Modal element:', modal);
            console.log('Preview image element:', img);
            
            if (!modal) {
                console.error('Image preview modal not found!');
                return;
            }
            
            if (!img) {
                console.error('Preview image element not found!');
                return;
            }
            
            if (!imageUrl || imageUrl === 'undefined' || imageUrl === 'null') {
                console.error('Invalid image URL:', imageUrl);
                return;
            }
            
            try {
                img.src = imageUrl;
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('Modal should be visible now');
            } catch (error) {
                console.error('Error showing image preview:', error);
            }
        };
        
        window.closeImagePreview = function() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        };
        
        // Test on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking for images...');
            const images = document.querySelectorAll('.clickable-image');
            console.log('Found', images.length, 'clickable images on DOMContentLoaded');
            
            images.forEach((img, index) => {
                console.log(`Image ${index}:`, img, 'URL:', img.getAttribute('data-image-url') || img.src);
                
                img.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Image clicked directly:', this);
                    
                    let imageUrl = this.getAttribute('data-image-url');
                    if (!imageUrl) {
                        imageUrl = this.src;
                    }
                    
                    console.log('Image URL to show:', imageUrl);
                    window.showImagePreview(imageUrl);
                });
            });
        });
        
        // Also try after window load
        window.addEventListener('load', function() {
            console.log('Window loaded, checking for images again...');
            setTimeout(function() {
                const images = document.querySelectorAll('.clickable-image');
                console.log('Found', images.length, 'clickable images after load');
                
                images.forEach((img, index) => {
                    if (!img.onclick) {
                        img.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Image clicked (load handler):', this);
                            
                            let imageUrl = this.getAttribute('data-image-url');
                            if (!imageUrl) {
                                imageUrl = this.src;
                            }
                            
                            console.log('Image URL to show:', imageUrl);
                            window.showImagePreview(imageUrl);
                        });
                    }
                });
            }, 500);
        });
    </script>
</body>
</html>


