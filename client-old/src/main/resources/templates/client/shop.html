<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Văn phòng phẩm - Cửa hàng</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/shop.css}" />
</head>
<body>
    <div th:replace="~{client/fragments/header :: client-header(${search})}"></div>

    <!-- Active Promotions Carousel -->
    <section class="promotion-slider" id="promotionSliderSection">
        <div class="container">
            <div class="promotion-carousel" id="promotionCarousel">
                <button class="promotion-nav prev" type="button" aria-label="Khuyến mãi trước" id="promotionPrev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="promotion-carousel-track" id="promotionCarouselTrack"></div>
                <button class="promotion-nav next" type="button" aria-label="Khuyến mãi tiếp theo" id="promotionNext">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="promotion-indicators" id="promotionIndicators"></div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="shop-container">
        <div class="shop-header-section">
            <h1 class="shop-title">Sản phẩm văn phòng phẩm</h1>
            <div class="results-count" th:text="'Tìm thấy ' + ${totalElements} + ' sản phẩm'">Tìm thấy 0 sản phẩm</div>
        </div>

        <!-- Products Grid -->
        <div th:if="${products != null && !products.isEmpty()}" class="products-grid">
            <div
                th:each="product : ${products}"
                class="product-card"
                th:data-product-link="@{'/shop/product/' + ${product.id}}"
                th:with="hasDiscount=${product.discountPrice != null && product.price != null && product.discountPrice < product.price},
                         discountPercent=${hasDiscount ? ((product.price.doubleValue() - product.discountPrice.doubleValue()) / product.price.doubleValue() * 100) : 0}"
                onclick="handleProductCardNavigate(event, this.dataset.productLink)"
            >
                <div class="product-image-wrapper">
                    <img 
                        th:src="${product.thumbnailUrl != null ? product.thumbnailUrl : '/image/placeholder.png'}" 
                        th:alt="${product.name}"
                        class="product-image"
                        onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'280\' height=\'280\'%3E%3Crect fill=\'%23f0f0f0\' width=\'280\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-family=\'Arial\' font-size=\'14\'%3ENo Image%3C/text%3E%3C/svg%3E'"
                    />
                    <div th:if="${hasDiscount}" class="product-badge">
                        <i class="fas fa-tag"></i> 
                        <span th:text="${#numbers.formatDecimal(discountPercent, 0, 'POINT', 0, 'POINT')} + '%'">0%</span>
                    </div>
                </div>
                <div class="product-info">
                    <div class="product-brand" th:text="${product.brand != null ? product.brand : 'Thương hiệu'}">Brand</div>
                    <h3 class="product-name" th:text="${product.name}">Tên sản phẩm</h3>
                    <p class="product-description" th:text="${product.description != null ? product.description : 'Mô tả sản phẩm'}">Mô tả</p>
                    <div class="product-price-section">
                        <span class="product-price" th:text="${#numbers.formatDecimal(hasDiscount ? product.discountPrice : product.price, 0, 'POINT', 0, 'POINT')} + ' ₫'">0 ₫</span>
                        <span 
                            th:if="${hasDiscount}"
                            class="product-price-old" 
                            th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'POINT')} + ' ₫'"
                        ></span>
                        <span 
                            th:if="${hasDiscount}"
                            class="product-discount"
                            th:text="'-' + ${#numbers.formatDecimal(discountPercent, 0, 'POINT', 0, 'POINT')} + '%'"
                        ></span>
                    </div>
                </div>
                <div class="product-card-actions">
                    <button type="button" class="btn-add-to-cart" th:onclick="|handleProductAddToCart(event, ${product.id})|">
                        <i class="fas fa-shopping-cart"></i>
                        Thêm vào giỏ hàng
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${products == null || products.isEmpty()}" class="empty-state">
            <i class="fas fa-box-open"></i>
            <h3>Không tìm thấy sản phẩm</h3>
            <p>Hãy thử tìm kiếm với từ khóa khác hoặc xem tất cả sản phẩm.</p>
        </div>

        <!-- Pagination -->
        <div th:if="${totalPages > 1}" class="pagination">
            <a 
                th:if="${hasPrev}"
                th:href="@{/shop(page=${currentPage - 1}, size=${size}, sort=${sort}, direction=${direction}, search=${search}, brand=${brand}, categoryId=${categoryId})}"
                class="pagination-btn"
            >
                <i class="fas fa-chevron-left"></i> Trước
            </a>
            <span th:if="${!hasPrev}" class="pagination-btn disabled">
                <i class="fas fa-chevron-left"></i> Trước
            </span>
            
            <span th:each="pageNum : ${#numbers.sequence(1, totalPages)}">
                <a 
                    th:if="${pageNum == currentPage}"
                    class="pagination-btn active"
                    th:text="${pageNum}"
                ></a>
                <a 
                    th:if="${pageNum != currentPage && (pageNum <= 3 || pageNum > totalPages - 3 || (pageNum >= currentPage - 1 && pageNum <= currentPage + 1))}"
                    th:href="@{/shop(page=${pageNum}, size=${size}, sort=${sort}, direction=${direction}, search=${search}, brand=${brand}, categoryId=${categoryId})}"
                    class="pagination-btn"
                    th:text="${pageNum}"
                ></a>
            </span>
            
            <a 
                th:if="${hasNext}"
                th:href="@{/shop(page=${currentPage + 1}, size=${size}, sort=${sort}, direction=${direction}, search=${search}, brand=${brand}, categoryId=${categoryId})}"
                class="pagination-btn"
            >
                Sau <i class="fas fa-chevron-right"></i>
            </a>
            <span th:if="${!hasNext}" class="pagination-btn disabled">
                Sau <i class="fas fa-chevron-right"></i>
            </span>
        </div>
    </div>

    <script th:src="@{/js/lib.js}"></script>
    <script th:src="@{/js/cart-manager.js}"></script>
    <script th:src="@{/js/home.js}"></script>
    <script>
        // Theme toggle functions
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            if (text) {
                text.textContent = theme === 'dark' ? 'Light' : 'Dark';
            }
        }
        
        function handleProductCardNavigate(event, url) {
            if (!url) {
                return;
            }
            window.location.href = url;
        }

        function handleProductAddToCart(event, productId) {
            event.stopPropagation();
            try {
                addCartItem(productId, 1);
                updateCartBadge();
                showNotification('Đã thêm sản phẩm vào giỏ hàng.', 'success');
            } catch (error) {
                console.error('Failed to add product to cart', error);
                showNotification('Không thể thêm sản phẩm vào giỏ hàng.', 'error');
            }
        }

        window.addEventListener('load', function() {
            initTheme();
            updateCartBadge();
        });

        // Listen to cart updates
        document.addEventListener('cart:updated', function() {
            updateCartBadge();
        });
    </script>
</body>
</html>
