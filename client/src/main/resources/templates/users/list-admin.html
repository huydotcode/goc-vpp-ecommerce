<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quản lý Users</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/api.js}"></script>
    <script th:src="@{/js/lib.js}"></script>
    <script th:src="@{/js/entity-manager.js}"></script>
    <script th:src="@{/js/image-upload-manager.js}"></script>
    <script th:src="@{/js/users.js}"></script>
</head>
<body>
    <div th:replace="~{layouts/admin :: adminLayout(~{::section}, 'Quản lý Users', 'users')}">
        <section>
                <div class="admin-card">
                    <div class="admin-card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;"><i class="fas fa-list"></i> Danh sách Users</h4>
                            <button type="button" class="btn btn-primary" onclick="showCreateModal()">
                                <i class="fas fa-plus"></i> Tạo User
                            </button>
                        </div>
                    </div>
                    <div class="admin-card-body">
                        <!-- Filter Form -->
                        <form id="filterForm" class="mb-4" th:action="@{/users}" method="get">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div class="form-group">
                                    <label for="id"><i class="fas fa-hashtag" style="margin-right:6px;"></i>ID:</label>
                                    <input type="text" id="id" name="id" class="form-control" 
                                           th:value="${id}" placeholder="Tìm theo ID...">
                                </div>
                                <div class="form-group">
                                    <label for="role"><i class="fas fa-user-shield" style="margin-right:6px;"></i>Role:</label>
                                    <select id="role" name="role" class="form-control">
                                        <option value="">Tất cả</option>
                                        <option value="ADMIN" th:selected="${role == 'ADMIN'}">ADMIN</option>
                                        <option value="EMPLOYEE" th:selected="${role == 'EMPLOYEE'}">EMPLOYEE</option>
                                        <option value="USER" th:selected="${role == 'USER'}">USER</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="username"><i class="fas fa-user" style="margin-right:6px;"></i>Username:</label>
                                    <input type="text" id="username" name="username" class="form-control" 
                                           th:value="${username}" placeholder="Tìm theo username...">
                                </div>
                                <div class="form-group">
                                    <label for="email"><i class="fas fa-envelope" style="margin-right:6px;"></i>Email:</label>
                                    <input type="text" id="email" name="email" class="form-control" 
                                           th:value="${email}" placeholder="Tìm theo email...">
                                </div>
                                <div class="form-group">
                                    <label for="isActive"><i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái:</label>
                                    <select id="isActive" name="isActive" class="form-control">
                                        <option value="">Tất cả</option>
                                        <option value="true" th:selected="${isActive == true}">Active</option>
                                        <option value="false" th:selected="${isActive == false}">Inactive</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="search"><i class="fas fa-search" style="margin-right:6px;"></i>Tìm kiếm:</label>
                                    <input type="text" id="search" name="search" class="form-control" 
                                           th:value="${search}" placeholder="Nhập username, email hoặc id.">
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Lọc
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetAllFilters()">
                                    <i class="fas fa-times"></i> Xóa bộ lọc
                                </button>
                            </div>
                        </form>

                        <!-- Table Loading Overlay -->
                        <div class="table-loading-overlay" id="tableLoadingOverlay">
                            <div class="loading-spinner"></div>
                        </div>

                        <!-- Notification Container -->
                        <div id="notificationContainer"></div>
                        
                        <!-- Flash Messages -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <!-- Users Table -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <a th:href="@{/users(sort='id', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-hashtag" style="margin-right:6px;"></i>ID
                                                <i th:if="${sort == 'id'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='username', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-user" style="margin-right:6px;"></i>Username
                                                <i th:if="${sort == 'username'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th><i class="fas fa-image" style="margin-right:6px;"></i>Avatar</th>
                                        <th>
                                            <a th:href="@{/users(sort='email', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-envelope" style="margin-right:6px;"></i>Email
                                                <i th:if="${sort == 'email'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='role', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-user-shield" style="margin-right:6px;"></i>Role
                                                <i th:if="${sort == 'role'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='isActive', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái
                                                <i th:if="${sort == 'isActive'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='createdAt', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-clock" style="margin-right:6px;"></i>Ngày tạo
                                                <i th:if="${sort == 'createdAt'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th class="text-center"><i class="fas fa-ellipsis-h" style="margin-right:6px;"></i>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="user : ${users}" th:attr="data-user-id=${user.id}">
                                        <td th:text="${user.id}"></td>
                                        <!-- Username -->
                                        <td>
                                            <span class="cell-view" th:text="${user.username}"></span>
                                            <input class="cell-edit form-control" style="display:none;" th:attr="data-field='username'" th:value="${user.username}" />
                                        </td>
                                        <!-- Avatar -->
                                        <td>
                                            <span class="cell-view">
                                                <img th:if="${user.avatarUrl}" th:src="${user.avatarUrl}" alt="avatar" 
                                                     class="clickable-image" 
                                                     th:attr="data-image-url=${user.avatarUrl}"
                                                     style="width:48px;height:48px;object-fit:cover;border-radius:50%;cursor:pointer;border: 2px solid transparent; transition: all 0.3s ease;"
                                                     onmouseover="this.style.borderColor='#ff7a45'; this.style.transform='scale(1.1)'"
                                                     onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"/>
                                                <span th:if="${user.avatarUrl == null || user.avatarUrl.isEmpty()}">-</span>
                                            </span>
                                            <div class="cell-edit" style="display:none;">
                                                <div class="upload-url-input-container">
                                                    <input class="form-control upload-url-input" th:attr="data-field='avatarUrl'" th:value="${user.avatarUrl}" placeholder="Avatar URL" />
                                                </div>
                                                <div class="inline-upload-area" th:attr="data-user-id=${user.id}" onclick="triggerFileInput(this)">
                                                    <i class="fas fa-cloud-upload-alt inline-upload-icon"></i>
                                                    <div class="inline-upload-text">Kéo thả ảnh hoặc click</div>
                                                    <div class="inline-upload-hint">JPG, PNG, WEBP, AVIF - max 2MB</div>
                                                    <input type="file" class="upload-area-file-input" accept="image/jpeg,image/png,image/webp,image/avif" 
                                                           th:id="'avatarUrlFile' + ${user.id}" th:attr="data-user-id=${user.id}, onchange='handleAvatarUpload(this, ' + ${user.id} + ')'" />
                                                </div>
                                                <div class="upload-preview-container"></div>
                                            </div>
                                        </td>
                                        <!-- Email -->
                                        <td>
                                            <span class="cell-view" th:text="${user.email}"></span>
                                            <input class="cell-edit form-control" style="display:none;" th:attr="data-field='email'" th:value="${user.email}" />
                                        </td>
                                        <!-- Role -->
                                        <td>
                                            <span class="cell-view">
                                                <span th:if="${user.role == 'ADMIN'}" class="badge bg-primary"><i class="fas fa-user-shield"></i> ADMIN</span>
                                                <span th:if="${user.role == 'EMPLOYEE'}" class="badge bg-secondary"><i class="fas fa-user-tie"></i> EMPLOYEE</span>
                                                <span th:if="${user.role == 'USER'}" class="badge bg-info"><i class="fas fa-user"></i> USER</span>
                                            </span>
                                            <select class="cell-edit form-control" style="display:none;" th:attr="data-field='role'">
                                                <option value="USER" th:selected="${user.role=='USER'}">USER</option>
                                                <option value="EMPLOYEE" th:selected="${user.role=='EMPLOYEE'}">EMPLOYEE</option>
                                                <option value="ADMIN" th:selected="${user.role=='ADMIN'}">ADMIN</option>
                                            </select>
                                        </td>
                                        <!-- Active -->
                                        <td>
                                            <span class="cell-view">
                                                <span th:if="${user.isActive}" class="badge bg-success">Active</span>
                                                <span th:unless="${user.isActive}" class="badge bg-danger">Inactive</span>
                                            </span>
                                            <select class="cell-edit form-control" style="display:none;" th:attr="data-field='isActive'">
                                                <option value="true" th:selected="${user.isActive}">Active</option>
                                                <option value="false" th:selected="${!user.isActive}">Inactive</option>
                                            </select>
                                        </td>
                                        <td th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                                        <td class="text-center">
                                            <div class="cell-view">
                                                <button type="button" class="btn btn-info btn-sm" title="Xem" th:onclick="'viewUser(' + ${user.id} + ')'">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                                <button type="button" class="btn btn-warning btn-sm" title="Sửa" th:onclick="'enterUserEditMode(' + ${user.id} + ')'">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                                
                                            </div>
                                            <div class="cell-edit" style="display:none;">
                                                <button type="button" class="btn btn-success btn-sm" th:onclick="'saveInlineUser(' + ${user.id} + ')'">Lưu</button>
                                                <button type="button" class="btn btn-secondary btn-sm" th:onclick="'cancelUserEditMode(' + ${user.id} + ')'">Hủy</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(users)}">
                                        <td colspan="8">Không có dữ liệu</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Page Size Selector -->
                        <div class="page-size-selector">
                            <label for="pageSize">Hiển thị:</label>
                            <select id="pageSize" name="pageSize" onchange="changePageSize()">
                                <option value="5" th:selected="${size == 5}">5</option>
                                <option value="10" th:selected="${size == 10}">10</option>
                                <option value="20" th:selected="${size == 20}">20</option>
                                <option value="50" th:selected="${size == 50}">50</option>
                                <option value="100" th:selected="${size == 100}">100</option>
                            </select>
                            <span>kết quả/trang</span>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination">
                            <a th:if="${hasPrev}" th:href="@{/users(page=${currentPage - 1}, size=${size}, sort=${sort}, direction=${direction}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}"><i class="fas fa-chevron-left"></i> Trước</a>
                            <span th:text="${currentPage} + ' / ' + ${totalPages}"></span>
                            <a th:if="${hasNext}" th:href="@{/users(page=${currentPage + 1}, size=${size}, sort=${sort}, direction=${direction}, id=${id}, role=${role}, isActive=${isActive}, search=${search})}">Tiếp <i class="fas fa-chevron-right"></i></a>
                        </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tạo User Mới</h3>
                <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="createUsername">Username *</label>
                            <input type="text" id="createUsername" name="username" class="form-control" required>
                            <div class="error-message" id="createUsernameError"></div>
                        </div>
                        <div class="form-group">
                            <label for="createEmail">Email *</label>
                            <input type="email" id="createEmail" name="email" class="form-control" required>
                            <div class="error-message" id="createEmailError"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="createPassword">Password *</label>
                            <input type="password" id="createPassword" name="password" class="form-control" required>
                            <div class="error-message" id="createPasswordError"></div>
                        </div>
                        <div class="form-group">
                            <label for="createRole">Role *</label>
                            <select id="createRole" name="role" class="form-control" required>
                                <option value="">Chọn role</option>
                                <option value="USER">USER</option>
                                <option value="EMPLOYEE">EMPLOYEE</option>
                                <option value="ADMIN">ADMIN</option>
                            </select>
                            <div class="error-message" id="createRoleError"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="createUserAvatar"><i class="fas fa-image" style="margin-right: 6px;"></i>Avatar</label>
                        <div class="upload-url-input-container">
                            <input id="createUserAvatar" class="form-control upload-url-input" type="text" name="avatarUrl" placeholder="Nhập URL ảnh hoặc upload bên dưới" />
                        </div>
                        <div class="upload-error-message" id="createUserAvatarError"></div>
                        <div class="upload-area" onclick="triggerFileInput(this)" data-create-mode="true">
                            <i class="fas fa-cloud-upload-alt upload-area-icon"></i>
                            <div class="upload-area-text">Kéo thả ảnh vào đây hoặc click để chọn</div>
                            <div class="upload-area-hint">JPG, PNG, WEBP, AVIF - Tối đa 2MB</div>
                            <input type="file" id="createUserAvatarFile" class="upload-area-file-input" accept="image/jpeg,image/png,image/webp,image/avif" onchange="handleAvatarUpload(this)" />
                        </div>
                        <div class="upload-progress-container" id="createProgressContainer">
                            <div class="upload-progress-label">
                                <span>Đang upload ảnh...</span>
                                <span class="upload-progress-percent">0%</span>
                            </div>
                            <div class="upload-progress-bar">
                                <div class="upload-progress-fill"></div>
                            </div>
                        </div>
                        <div id="createUserPreviewContainer" class="upload-preview-container"></div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="createIsActive" name="isActive" checked>
                            Kích hoạt tài khoản
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createModal')">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateUser()">Tạo User</button>
            </div>
        </div>
    </div>

    

    <!-- View User Modal -->
    <!-- Drawer detail for User -->
    <div id="userDrawer" class="drawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3 class="drawer-title"><i class="fas fa-user" style="margin-right:8px;"></i>Chi tiết User</h3>
                <button class="modal-close" onclick="closeDrawer('userDrawer')">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="desc-section">
                    <h4 class="desc-section-title">Thông tin cơ bản</h4>
                    <div class="desc-grid">
                        <div class="desc-label">ID</div><div class="desc-value" id="viewId">-</div>
                        <div class="desc-label">Username</div><div class="desc-value" id="viewUsername">-</div>
                        <div class="desc-label">Email</div><div class="desc-value" id="viewEmail">-</div>
                        <div class="desc-label">Role</div><div class="desc-value" id="viewRole">-</div>
                        <div class="desc-label">Trạng thái</div><div class="desc-value" id="viewIsActive">-</div>
                        <div class="desc-label">Avatar</div><div class="desc-value"><img id="viewAvatar" class="thumb-lg clickable-image" alt="avatar" style="display:none;border-radius:50%;cursor:pointer;" /></div>
                    </div>
                </div>
                <div class="desc-section">
                    <h4 class="desc-section-title">Thông tin hệ thống</h4>
                    <div class="desc-grid">
                        <div class="desc-label">Ngày tạo</div><div class="desc-value" id="viewCreatedAt">-</div>
                        <div class="desc-label">Ngày cập nhật</div><div class="desc-value" id="viewUpdatedAt">-</div>
                        <div class="desc-label">Tạo bởi</div><div class="desc-value" id="viewCreatedBy">-</div>
                        <div class="desc-label">Cập nhật bởi</div><div class="desc-value" id="viewUpdatedBy">-</div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDrawer('userDrawer')">Đóng</button>
            </div>
        </div>
    </div>

    

        </section>
    </div>

    <!-- Image Preview Modal (Lightbox) -->
    <div id="imagePreviewModal" class="image-preview-modal">
        <div class="image-preview-content">
            <img id="previewImage" src="" alt="Image Preview" />
            <button class="image-preview-close" onclick="closeImagePreview()">&times;</button>
        </div>
    </div>
    
    <script>
        // Ensure functions are globally available
        window.showImagePreview = function(imageUrl) {
            console.log('showImagePreview called with:', imageUrl);
            
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('previewImage');
            
            console.log('Modal element:', modal);
            console.log('Preview image element:', img);
            
            if (!modal) {
                console.error('Image preview modal not found!');
                return;
            }
            
            if (!img) {
                console.error('Preview image element not found!');
                return;
            }
            
            if (!imageUrl || imageUrl === 'undefined' || imageUrl === 'null') {
                console.error('Invalid image URL:', imageUrl);
                return;
            }
            
            try {
                img.src = imageUrl;
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('Modal should be visible now');
            } catch (error) {
                console.error('Error showing image preview:', error);
            }
        };
        
        window.closeImagePreview = function() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        };
        
        // Test on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking for images...');
            const images = document.querySelectorAll('.clickable-image');
            console.log('Found', images.length, 'clickable images on DOMContentLoaded');
            
            images.forEach((img, index) => {
                console.log(`Image ${index}:`, img, 'URL:', img.getAttribute('data-image-url') || img.src);
                
                img.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Image clicked directly:', this);
                    
                    let imageUrl = this.getAttribute('data-image-url');
                    if (!imageUrl) {
                        imageUrl = this.src;
                    }
                    
                    console.log('Image URL to show:', imageUrl);
                    window.showImagePreview(imageUrl);
                });
            });
        });
        
        // Also try after window load
        window.addEventListener('load', function() {
            console.log('Window loaded, checking for images again...');
            setTimeout(function() {
                const images = document.querySelectorAll('.clickable-image');
                console.log('Found', images.length, 'clickable images after load');
                
                images.forEach((img, index) => {
                    if (!img.onclick) {
                        img.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Image clicked (load handler):', this);
                            
                            let imageUrl = this.getAttribute('data-image-url');
                            if (!imageUrl) {
                                imageUrl = this.src;
                            }
                            
                            console.log('Image URL to show:', imageUrl);
                            window.showImagePreview(imageUrl);
                        });
                    }
                });
            }, 500);
        });
    </script>
</body>
</html>