<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quản lý Users</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div th:replace="~{layouts/admin :: adminLayout(~{::section}, 'Quản lý Users', 'users')}">
        <section>
                <div class="admin-card">
                    <div class="admin-card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;"><i class="fas fa-list"></i> Danh sách Users</h4>
                            <button type="button" class="btn btn-primary" onclick="showCreateModal()">
                                <i class="fas fa-plus"></i> Tạo User
                            </button>
                        </div>
                    </div>
                    <div class="admin-card-body">
                        <!-- Filter Form -->
                        <form id="filterForm" class="mb-4">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div class="form-group">
                                    <label for="role"><i class="fas fa-user-shield" style="margin-right:6px;"></i>Role:</label>
                                    <select id="role" name="role" class="form-control">
                                        <option value="">Tất cả</option>
                                        <option value="ADMIN" th:selected="${role == 'ADMIN'}">ADMIN</option>
                                        <option value="EMPLOYEE" th:selected="${role == 'EMPLOYEE'}">EMPLOYEE</option>
                                        <option value="USER" th:selected="${role == 'USER'}">USER</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="username"><i class="fas fa-user" style="margin-right:6px;"></i>Username:</label>
                                    <input type="text" id="username" name="username" class="form-control" 
                                           th:value="${username}" placeholder="Tìm theo username...">
                                </div>
                                <div class="form-group">
                                    <label for="email"><i class="fas fa-envelope" style="margin-right:6px;"></i>Email:</label>
                                    <input type="text" id="email" name="email" class="form-control" 
                                           th:value="${email}" placeholder="Tìm theo email...">
                                </div>
                                <div class="form-group">
                                    <label for="isActive"><i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái:</label>
                                    <select id="isActive" name="isActive" class="form-control">
                                        <option value="">Tất cả</option>
                                        <option value="true" th:selected="${isActive == true}">Active</option>
                                        <option value="false" th:selected="${isActive == false}">Inactive</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="search"><i class="fas fa-search" style="margin-right:6px;"></i>Tìm kiếm:</label>
                                    <input type="text" id="search" name="search" class="form-control" 
                                           th:value="${search}" placeholder="Nhập username, email hoặc id.">
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Lọc
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetAllFilters()">
                                    <i class="fas fa-times"></i> Xóa bộ lọc
                                </button>
                            </div>
                        </form>

                        <!-- Table Loading Overlay -->
                        <div class="table-loading-overlay" id="tableLoadingOverlay">
                            <div class="loading-spinner"></div>
                        </div>

                        <!-- Users Table -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <a th:href="@{/users(sort='id', direction=${direction == 'asc' ? 'desc' : 'asc'}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-hashtag" style="margin-right:6px;"></i>ID
                                                <i th:if="${sort == 'id'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='username', direction=${direction == 'asc' ? 'desc' : 'asc'}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-user" style="margin-right:6px;"></i>Username
                                                <i th:if="${sort == 'username'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='email', direction=${direction == 'asc' ? 'desc' : 'asc'}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-envelope" style="margin-right:6px;"></i>Email
                                                <i th:if="${sort == 'email'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='role', direction=${direction == 'asc' ? 'desc' : 'asc'}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-user-shield" style="margin-right:6px;"></i>Role
                                                <i th:if="${sort == 'role'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='isActive', direction=${direction == 'asc' ? 'desc' : 'asc'}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái
                                                <i th:if="${sort == 'isActive'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/users(sort='createdAt', direction=${direction == 'asc' ? 'desc' : 'asc'}, role=${role}, isActive=${isActive}, search=${search})}" 
                                               class="text-decoration-none">
                                                <i class="fas fa-clock" style="margin-right:6px;"></i>Ngày tạo
                                                <i th:if="${sort == 'createdAt'}" 
                                                   th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                            </a>
                                        </th>
                                        <th class="text-center"><i class="fas fa-ellipsis-h" style="margin-right:6px;"></i>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="user : ${users}" th:attr="data-user-id=${user.id}">
                                        <td th:text="${user.id}"></td>
                                        <!-- Username -->
                                        <td>
                                            <span class="cell-view" th:text="${user.username}"></span>
                                            <input class="cell-edit form-control" style="display:none;" th:attr="data-field='username'" th:value="${user.username}" />
                                        </td>
                                        <!-- Email -->
                                        <td>
                                            <span class="cell-view" th:text="${user.email}"></span>
                                            <input class="cell-edit form-control" style="display:none;" th:attr="data-field='email'" th:value="${user.email}" />
                                        </td>
                                        <!-- Role -->
                                        <td>
                                            <span class="cell-view">
                                                <span th:if="${user.role == 'ADMIN'}" class="badge badge-primary-soft"><i class="fas fa-user-shield"></i> ADMIN</span>
                                                <span th:if="${user.role == 'EMPLOYEE'}" class="badge badge-muted"><i class="fas fa-user-tie"></i> EMPLOYEE</span>
                                                <span th:if="${user.role == 'USER'}" class="badge badge-outline"><i class="fas fa-user"></i> USER</span>
                                            </span>
                                            <select class="cell-edit form-control" style="display:none;" th:attr="data-field='role'">
                                                <option value="USER" th:selected="${user.role=='USER'}">USER</option>
                                                <option value="EMPLOYEE" th:selected="${user.role=='EMPLOYEE'}">EMPLOYEE</option>
                                                <option value="ADMIN" th:selected="${user.role=='ADMIN'}">ADMIN</option>
                                            </select>
                                        </td>
                                        <!-- Active -->
                                        <td>
                                            <span class="cell-view">
                                                <span th:if="${user.isActive}" class="badge badge-primary-soft"><i class="fas fa-check"></i> Active</span>
                                                <span th:unless="${user.isActive}" class="badge badge-outline"><i class="fas fa-ban"></i> Inactive</span>
                                            </span>
                                            <select class="cell-edit form-control" style="display:none;" th:attr="data-field='isActive'">
                                                <option value="true" th:selected="${user.isActive}">Active</option>
                                                <option value="false" th:selected="${!user.isActive}">Inactive</option>
                                            </select>
                                        </td>
                                        <td th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                                        <td class="text-center">
                                            <div class="cell-view">
                                                <button type="button" class="btn btn-info btn-sm" title="Xem" th:onclick="'viewUser(' + ${user.id} + ')'">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                                <button type="button" class="btn btn-warning btn-sm" title="Sửa" th:onclick="'enterUserEditMode(' + ${user.id} + ')'">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                                
                                            </div>
                                            <div class="cell-edit" style="display:none;">
                                                <button type="button" class="btn btn-success btn-sm" th:onclick="'saveInlineUser(' + ${user.id} + ')'">Lưu</button>
                                                <button type="button" class="btn btn-secondary btn-sm" th:onclick="'cancelUserEditMode(' + ${user.id} + ')'">Hủy</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Page Size Selector -->
                        <div class="page-size-selector">
                            <label for="pageSize">Hiển thị:</label>
                            <select id="pageSize" name="pageSize" onchange="changePageSize()">
                                <option value="5" th:selected="${size == 5}">5</option>
                                <option value="10" th:selected="${size == 10}">10</option>
                                <option value="20" th:selected="${size == 20}">20</option>
                                <option value="50" th:selected="${size == 50}">50</option>
                                <option value="100" th:selected="${size == 100}">100</option>
                            </select>
                            <span>kết quả/trang</span>
                        </div>

                        <!-- Pagination -->
                        <nav th:if="${totalPages > 1}" aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                                <!-- Previous -->
                                <li class="page-item" th:classappend="${!hasPrev} ? 'disabled'">
                                    <a class="page-link" 
                                       th:href="@{/users(page=${currentPage - 1}, size=${size}, sort=${sort}, direction=${direction}, role=${role}, isActive=${isActive}, search=${search})}"
                                       th:attr="data-page=${currentPage - 1}"
                                       th:if="${hasPrev}">
                                        <i class="fas fa-chevron-left"></i> Trước
                                    </a>
                                    <span class="page-link" th:unless="${hasPrev}">
                                        <i class="fas fa-chevron-left"></i> Trước
                                    </span>
                                </li>
                                
                                <!-- Page Numbers -->
                                <li th:each="pageNum : ${#numbers.sequence(1, totalPages)}" 
                                    class="page-item" 
                                    th:classappend="${pageNum == currentPage} ? 'active'">
                                    <a class="page-link" 
                                       th:href="@{/users(page=${pageNum}, size=${size}, sort=${sort}, direction=${direction}, role=${role}, isActive=${isActive}, search=${search})}"
                                       th:attr="data-page=${pageNum}"
                                       th:text="${pageNum}"></a>
                                </li>
                                
                                <!-- Next -->
                                <li class="page-item" th:classappend="${!hasNext} ? 'disabled'">
                                    <a class="page-link" 
                                       th:href="@{/users(page=${currentPage + 1}, size=${size}, sort=${sort}, direction=${direction}, role=${role}, isActive=${isActive}, search=${search})}"
                                       th:attr="data-page=${currentPage + 1}"
                                       th:if="${hasNext}">
                                        Tiếp <i class="fas fa-chevron-right"></i>
                                    </a>
                                    <span class="page-link" th:unless="${hasNext}">
                                        Tiếp <i class="fas fa-chevron-right"></i>
                                    </span>
                                </li>
                            </ul>
                        </nav>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Create User Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tạo User Mới</h3>
                <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="createUsername">Username *</label>
                            <input type="text" id="createUsername" name="username" class="form-control" required>
                            <div class="error-message" id="createUsernameError"></div>
                        </div>
                        <div class="form-group">
                            <label for="createEmail">Email *</label>
                            <input type="email" id="createEmail" name="email" class="form-control" required>
                            <div class="error-message" id="createEmailError"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="createPassword">Password *</label>
                            <input type="password" id="createPassword" name="password" class="form-control" required>
                            <div class="error-message" id="createPasswordError"></div>
                        </div>
                        <div class="form-group">
                            <label for="createRole">Role *</label>
                            <select id="createRole" name="role" class="form-control" required>
                                <option value="">Chọn role</option>
                                <option value="USER">USER</option>
                                <option value="EMPLOYEE">EMPLOYEE</option>
                                <option value="ADMIN">ADMIN</option>
                            </select>
                            <div class="error-message" id="createRoleError"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="createIsActive" name="isActive" checked>
                            Kích hoạt tài khoản
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createModal')">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateUser()">Tạo User</button>
            </div>
        </div>
    </div>

    

    <!-- View User Modal -->
    <!-- Drawer detail for User -->
    <div id="userDrawer" class="drawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3 class="drawer-title"><i class="fas fa-user" style="margin-right:8px;"></i>Chi tiết User</h3>
                <button class="modal-close" onclick="closeDrawer('userDrawer')">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="desc-section">
                    <h4 class="desc-section-title">Thông tin cơ bản</h4>
                    <div class="desc-grid">
                        <div class="desc-label">ID</div><div class="desc-value" id="viewId">-</div>
                        <div class="desc-label">Username</div><div class="desc-value" id="viewUsername">-</div>
                        <div class="desc-label">Email</div><div class="desc-value" id="viewEmail">-</div>
                        <div class="desc-label">Role</div><div class="desc-value" id="viewRole">-</div>
                        <div class="desc-label">Trạng thái</div><div class="desc-value" id="viewIsActive">-</div>
                    </div>
                </div>
                <div class="desc-section">
                    <h4 class="desc-section-title">Thông tin hệ thống</h4>
                    <div class="desc-grid">
                        <div class="desc-label">Ngày tạo</div><div class="desc-value" id="viewCreatedAt">-</div>
                        <div class="desc-label">Ngày cập nhật</div><div class="desc-value" id="viewUpdatedAt">-</div>
                        <div class="desc-label">Tạo bởi</div><div class="desc-value" id="viewCreatedBy">-</div>
                        <div class="desc-label">Cập nhật bởi</div><div class="desc-value" id="viewUpdatedBy">-</div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDrawer('userDrawer')">Đóng</button>
            </div>
        </div>
    </div>

    

    <script>
        // Container Loading Functions (sử dụng overlay từ layout)
        function showContainerLoading(text = 'Đang tải...') {
            const overlay = document.getElementById('containerLoadingOverlay');
            const textElement = overlay.querySelector('.container-loading-text');
            if (overlay) {
                textElement.textContent = text;
                overlay.classList.add('show');
            }
        }

        function hideContainerLoading() {
            const overlay = document.getElementById('containerLoadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        // Table Loading Functions
        function showTableLoading() {
            const overlay = document.getElementById('tableLoadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function hideTableLoading() {
            const overlay = document.getElementById('tableLoadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Notification Functions
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                hideNotification(notification);
            }, 3000);
        }

        function hideNotification(notification) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }

        // submitFormWithLoading removed (không dùng)

        // Page size change handler
        function changePageSize() {
            showContainerLoading('Đang thay đổi kích thước trang...');
            const pageSize = document.getElementById('pageSize').value;
            const url = new URL(window.location);
            url.searchParams.set('size', pageSize);
            url.searchParams.set('page', '0'); // Reset to first page
            window.location.href = url.toString();
        }

        function goToPageWithLoading(page) {
            showContainerLoading('Đang chuyển trang...');
            window.location.href = page;
        }

        function submitFilterWithLoading() {
            showContainerLoading('Đang lọc dữ liệu...');
            
            // Get current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Clear all filter parameters first
            urlParams.delete('role');
            urlParams.delete('username');
            urlParams.delete('email');
            urlParams.delete('isActive');
            urlParams.delete('search');
            urlParams.delete('page'); // Reset to page 1
            
            // Add non-empty filter values
            const role = document.getElementById('role').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const isActive = document.getElementById('isActive').value;
            const search = document.getElementById('search').value;
            
            if (role && role !== '') urlParams.set('role', role);
            if (username && username.trim() !== '') urlParams.set('username', username);
            if (email && email.trim() !== '') urlParams.set('email', email);
            if (isActive && isActive !== '') urlParams.set('isActive', isActive);
            if (search && search.trim() !== '') urlParams.set('search', search);
            
            // Navigate to filtered URL
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.location.href = newUrl;
        }

        function resetAllFilters() {
            showContainerLoading('Đang xóa bộ lọc...');
            window.location.href = window.location.pathname;
        }

        // User Actions
        async function viewUser(id) {
            try {
                showTableLoading();
                const user = await fetchUserById(id);
                if (user) {
                    populateViewModal(user);
                    openDrawer('userDrawer');
                }
            } finally {
                hideTableLoading();
            }
        }

        // editUser removed (inline edit is used)

        // deleteUser removed (feature disabled)

        function showCreateModal() {
            clearCreateForm();
            showModal('createModal');
        }

        // Inline edit (giống Categories)
        function enterUserEditMode(id){
            const row = document.querySelector(`tr[data-user-id='${id}']`);
            if(!row) return;
            row.querySelectorAll('.cell-view').forEach(el => el.style.display='none');
            row.querySelectorAll('.cell-edit').forEach(el => el.style.display='');
        }
        function cancelUserEditMode(id){
            const row = document.querySelector(`tr[data-user-id='${id}']`);
            if(!row) return;
            row.querySelectorAll('.cell-edit').forEach(el => el.style.display='none');
            row.querySelectorAll('.cell-view').forEach(el => el.style.display='');
        }
        let isUpdatingUser = false;
        async function saveInlineUser(id){
            const row = document.querySelector(`tr[data-user-id='${id}']`);
            if(!row) return;
            if (isUpdatingUser) { return; }
            const getVal = (field) => {
                const el = row.querySelector(`.cell-edit[data-field='${field}']`);
                return el ? el.value : null;
            };
            const username = getVal('username');
            const email = getVal('email');
            const role = getVal('role');
            const isActiveVal = getVal('isActive');
            const isActive = String(isActiveVal) === 'true';

            // Reuse validation from modal
            let ok = true;
            if(!username || username.trim()===''){ ok=false; }
            if(!email || email.trim()===''){ ok=false; }
            if(!role || role.trim()===''){ ok=false; }
            if(!ok){ showNotification('Vui lòng nhập đủ thông tin bắt buộc', 'error'); return; }

            const userData = { id, username, email, password: null, role, isActive };
            const saveBtn = row.querySelector('.cell-edit .btn.btn-success');
            const cancelBtn = row.querySelector('.cell-edit .btn.btn-secondary');
            const disableRowEdit = (disable) => {
                if (saveBtn) saveBtn.disabled = disable;
                if (cancelBtn) cancelBtn.disabled = disable;
                row.querySelectorAll('.cell-edit input, .cell-edit select').forEach(i => i.disabled = disable);
            };
            try {
                showTableLoading();
                isUpdatingUser = true;
                disableRowEdit(true);
                const token = await getToken();
                const response = await fetch(`http://localhost:8080/api/v1/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(userData)
                });
                if(response.ok){
                    showNotification('Cập nhật user thành công!', 'success');
                    // Refresh to reflect badge texts quickly
                    setTimeout(()=>{ window.location.href = window.location.href; }, 400);
                } else {
                    const err = await response.json().catch(()=>({}));
                    showNotification(err.message || 'Lỗi khi cập nhật user', 'error');
                }
            } catch(e){
                console.error('Inline update error:', e);
                showNotification('Lỗi khi cập nhật user', 'error');
            } finally {
                hideTableLoading();
                isUpdatingUser = false;
                disableRowEdit(false);
            }
        }

        // Modal Management
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        function openDrawer(id){ const d=document.getElementById(id); if(d){ d.classList.add('show'); document.body.style.overflow='hidden'; } }
        function closeDrawer(id){ const d=document.getElementById(id); if(d){ d.classList.remove('show'); document.body.style.overflow=''; } }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // Fetch user by ID
        async function fetchUserById(id) {
            try {
                const token = await getToken();
                const response = await fetch(`http://localhost:8080/api/v1/users/${id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.data;
                } else {
                    showNotification('Không thể tải thông tin user', 'error');
                    return null;
                }
            } catch (error) {
                showNotification('Lỗi khi tải thông tin user', 'error');
                return null;
            }
        }

        // Get token from localStorage, cookie, or session
        async function getToken() {
            // Try localStorage first
            let token = localStorage.getItem('access_token');
            if (token) {
                return token;
            }
            
            // Try cookie
            token = getCookie('access_token');
            if (token) {
                return token;
            }
            
            // Try to get from session via API
            try {
                const response = await fetch('/api/auth/token', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    if (token) {
                        localStorage.setItem('access_token', token);
                        return token;
                    }
                }
            } catch (error) {
                
            }
            
            return null;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Populate modals
        function populateViewModal(user) {
            document.getElementById('viewId').textContent = user.id || '-';
            document.getElementById('viewUsername').textContent = user.username || '-';
            document.getElementById('viewEmail').textContent = user.email || '-';
            document.getElementById('viewRole').textContent = user.role || '-';
            document.getElementById('viewIsActive').textContent = user.isActive ? 'Active' : 'Inactive';
            document.getElementById('viewCreatedAt').textContent = formatDate(user.createdAt) || '-';
            document.getElementById('viewUpdatedAt').textContent = formatDate(user.updatedAt) || '-';
            document.getElementById('viewCreatedBy').textContent = user.createdBy || '-';
            document.getElementById('viewUpdatedBy').textContent = user.updatedBy || '-';
        }

        // populateEditModal removed (inline edit is used)

        // populateDeleteModal removed

        function clearCreateForm() {
            document.getElementById('createUserForm').reset();
            document.getElementById('createIsActive').checked = true;
            clearCreateErrors();
        }

        function clearCreateErrors() {
            const errorElements = document.querySelectorAll('#createUserForm .error-message');
            errorElements.forEach(el => el.textContent = '');
            const inputs = document.querySelectorAll('#createUserForm .form-control');
            inputs.forEach(input => input.classList.remove('error'));
        }

        // clearEditErrors removed

        // Form submissions
        let isSubmittingCreateUser = false;
        async function submitCreateUser() {
            if (isSubmittingCreateUser) { return; }
            const form = document.getElementById('createUserForm');
            const formData = new FormData(form);
            
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role'),
                isActive: formData.get('isActive') === 'on'
            };

            if (!validateCreateForm(userData)) {
                return;
            }

            const createBtn = document.querySelector('#createModal .btn.btn-primary');
            const cancelBtn = document.querySelector('#createModal .btn.btn-secondary');
            const disableControls = (disable) => {
                if (createBtn) { createBtn.disabled = disable; }
                if (cancelBtn) { cancelBtn.disabled = disable; }
                if (form) {
                    const inputs = form.querySelectorAll('input, select');
                    inputs.forEach(i => i.disabled = disable);
                }
            };

            try {
                showTableLoading();
                isSubmittingCreateUser = true;
                disableControls(true);
                const token = await getToken();
                const response = await fetch('http://localhost:8080/api/v1/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    showNotification('Tạo user thành công!', 'success');
                    closeModal('createModal');
                    setTimeout(() => {
                        window.location.href = window.location.href;
                    }, 500);
                } else {
                    const errorData = await response.json();
                    showNotification(errorData.message || 'Lỗi khi tạo user', 'error');
                }
            } catch (error) {
                showNotification('Lỗi khi tạo user', 'error');
            } finally {
                hideTableLoading();
                isSubmittingCreateUser = false;
                disableControls(false);
            }
        }

        // submitEditUser removed (inline edit is used)

        // confirmDeleteUser removed (feature disabled)

        // Form validation
        function validateCreateForm(data) {
            let isValid = true;
            clearCreateErrors();

            if (!data.username || data.username.trim() === '') {
                showFieldError('createUsername', 'Username là bắt buộc');
                isValid = false;
            }

            if (!data.email || data.email.trim() === '') {
                showFieldError('createEmail', 'Email là bắt buộc');
                isValid = false;
            } else if (!isValidEmail(data.email)) {
                showFieldError('createEmail', 'Email không hợp lệ');
                isValid = false;
            }

            if (!data.password || data.password.trim() === '') {
                showFieldError('createPassword', 'Password là bắt buộc');
                isValid = false;
            } else if (data.password.length < 6) {
                showFieldError('createPassword', 'Password phải có ít nhất 6 ký tự');
                isValid = false;
            }

            if (!data.role || data.role.trim() === '') {
                showFieldError('createRole', 'Role là bắt buộc');
                isValid = false;
            }

            return isValid;
        }

        // validateEditForm removed (inline edit uses lightweight checks)

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (field) {
                field.classList.add('error');
            }
            
            if (errorElement) {
                errorElement.textContent = message;
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('vi-VN');
            } catch (error) {
                return '-';
            }
        }

        // Actions from view modal
        // editUserFromView removed (drawer chỉ xem)

        // deleteUserFromView removed

        // testApiCall removed

        // Initialize on page load
        window.addEventListener('load', function() {
            // Check for success parameter and show notification
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                showNotification('Tải dữ liệu thành công!', 'success');
            }
            
            // Add event listeners for filter form
            const filterForm = document.getElementById('filterForm');
            if (filterForm) {
                filterForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitFilterWithLoading();
                });
            }
            
            // Add event listeners for pagination links
            const paginationLinks = document.querySelectorAll('.pagination a[data-page]');
            paginationLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    goToPageWithLoading(this.href);
                });
            });
            
            // Add event listeners for role and isActive selects
            const roleSelect = document.getElementById('role');
            const isActiveSelect = document.getElementById('isActive');
            
            if (roleSelect) {
                roleSelect.addEventListener('change', function() {
                    if (this.value === '') {
                        submitFilterWithLoading();
                    }
                });
            }
            
            if (isActiveSelect) {
                isActiveSelect.addEventListener('change', function() {
                    if (this.value === '') {
                        submitFilterWithLoading();
                    }
                });
            }
        });
    </script>
        </section>
    </div>
</body>
</html>