<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' - Chi tiết sản phẩm'">Chi tiết sản phẩm</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/shop.css}" />
</head>
<body>
    <div th:replace="~{client/fragments/header :: client-header(${product?.name})}"></div>

    <!-- Product Detail Container -->
    <div class="product-detail-container">
        <a th:href="@{/shop}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            Quay lại
        </a>

        <div class="product-detail-grid">
            <!-- Product Images -->
            <div class="product-detail-images">
                <img 
                    th:src="${product.thumbnailUrl != null ? product.thumbnailUrl : '/image/placeholder.png'}" 
                    th:alt="${product.name}"
                    class="product-detail-main-image"
                    id="mainImage"
                    onclick="openImageModal(this.src)"
                    onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'600\' height=\'600\'%3E%3Crect fill=\'%23f0f0f0\' width=\'600\' height=\'600\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-family=\'Arial\' font-size=\'16\'%3ENo Image%3C/text%3E%3C/svg%3E'"
                />
                <div th:if="${images != null && !images.isEmpty()}" class="product-detail-thumbnails">
                    <img 
                        th:each="image : ${images}"
                        th:src="${image.imageUrl}"
                        th:alt="${product.name}"
                        class="product-detail-thumbnail"
                        th:classappend="${image.isPrimary ? 'active' : ''}"
                        onclick="changeMainImage(this.src)"
                        onerror="this.style.display='none'"
                    />
                </div>
            </div>

            <!-- Product Info -->
            <div class="product-detail-info">
                <div class="product-detail-brand" th:text="${product.brand != null ? product.brand : 'Thương hiệu'}">Brand</div>
                <h1 class="product-detail-name" th:text="${product.name}">Tên sản phẩm</h1>
                
                <div class="product-detail-price-section"
                     th:with="hasDiscount=${product.discountPrice != null && product.price != null && product.discountPrice < product.price},
                              discountPercent=${hasDiscount ? ((product.price.doubleValue() - product.discountPrice.doubleValue()) / product.price.doubleValue() * 100) : 0}">
                    <span class="product-detail-price" th:text="${#numbers.formatDecimal(hasDiscount ? product.discountPrice : product.price, 0, 'POINT', 0, 'POINT')} + ' ₫'">0 ₫</span>
                    <span 
                        th:if="${hasDiscount}"
                        class="product-detail-price-old" 
                        th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'POINT')} + ' ₫'"
                    ></span>
                    <span 
                        th:if="${hasDiscount}"
                        class="product-detail-discount"
                        th:text="'-' + ${#numbers.formatDecimal(discountPercent, 0, 'POINT', 0, 'POINT')} + '%'"
                    ></span>
                </div>

                <div th:if="${product.description != null && !#strings.isEmpty(product.description)}" class="product-detail-description">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--text-color);">Mô tả sản phẩm</h3>
                    <p th:text="${product.description}">Mô tả</p>
                </div>

                <div class="product-detail-specs">
                    <h3>Thông tin chi tiết</h3>
                    <div class="spec-grid">
                        <div class="spec-label">SKU:</div>
                        <div class="spec-value" th:text="${product.sku != null ? product.sku : '-'}">-</div>
                        
                        <div class="spec-label">Thương hiệu:</div>
                        <div class="spec-value" th:text="${product.brand != null ? product.brand : '-'}">-</div>
                        
                        <div class="spec-label">Màu sắc:</div>
                        <div class="spec-value" th:text="${product.color != null ? product.color : '-'}">-</div>
                        
                        <div class="spec-label">Kích thước:</div>
                        <div class="spec-value" th:text="${product.size != null ? product.size : '-'}">-</div>
                        
                        <div class="spec-label">Trọng lượng:</div>
                        <div class="spec-value" th:text="${product.weight != null ? product.weight : '-'}">-</div>
                        
                        <div class="spec-label">Kích thước bao bì:</div>
                        <div class="spec-value" th:text="${product.dimensions != null ? product.dimensions : '-'}">-</div>
                        
                        <div class="spec-label">Số lượng tồn kho:</div>
                        <div class="spec-value" th:text="${product.stockQuantity != null ? product.stockQuantity : 0}">0</div>
                        
                        <div th:if="${product.specifications != null && !#strings.isEmpty(product.specifications)}" class="spec-label">Thông số kỹ thuật:</div>
                        <div th:if="${product.specifications != null && !#strings.isEmpty(product.specifications)}" class="spec-value" th:text="${product.specifications}">-</div>
                    </div>
                </div>

                <div class="product-detail-actions">
                    <button class="btn-add-to-cart" th:onclick="|handleAddToCart(${product.id})|">
                        <i class="fas fa-shopping-cart"></i>
                        Thêm vào giỏ hàng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="image-preview-modal" onclick="closeImageModal()">
        <div class="image-preview-content" onclick="event.stopPropagation()">
            <button class="image-preview-close" onclick="closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Product Image" />
        </div>
    </div>

    <script th:src="@{/js/lib.js}"></script>
    <script th:src="@{/js/cart-manager.js}"></script>
    <script>
        // Theme toggle functions
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            if (text) {
                text.textContent = theme === 'dark' ? 'Light' : 'Dark';
            }
        }
        
        // Image functions
        function changeMainImage(src) {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.product-detail-thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = src;
            modal.classList.add('show');
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
        }
        
        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });
        
        function handleAddToCart(productId) {
            try {
                addCartItem(productId, 1);
                updateCartBadge();
                showNotification('Đã thêm sản phẩm vào giỏ hàng.', 'success');
            } catch (error) {
                console.error('Failed to add product to cart', error);
                showNotification('Không thể thêm sản phẩm vào giỏ hàng.', 'error');
            }
        }

        window.addEventListener('load', function() {
            initTheme();
            updateCartBadge();
        });

        document.addEventListener('cart:updated', function() {
            updateCartBadge();
        });
    </script>
</body>
</html>

