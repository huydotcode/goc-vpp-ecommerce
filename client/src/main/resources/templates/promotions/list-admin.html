<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Promotions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <script th:src="@{/js/api.js}"></script>
    <script th:src="@{/js/lib.js}"></script>
    <script th:src="@{/js/image-upload-manager.js}"></script>
    <script th:src="@{/js/promotions.js}"></script>
    <style>
        .thumb { width:48px; height:48px; object-fit:cover; border-radius:4px; cursor:pointer; }
        .discount-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .discount-amount { background: var(--success-light); color: var(--success-color); }
        .discount-gift { background: var(--info-light); color: var(--info-color); }
    </style>
</head>
<body>
    <div th:replace="~{layouts/admin :: adminLayout(~{::section}, 'Quản lý Promotions', 'promotions')}">
        <section>
            <div class="admin-card">
                <div class="admin-card-header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h4 style="margin:0;"><i class="fas fa-gift"></i> Danh sách Promotions</h4>
                        <button type="button" class="btn btn-primary" onclick="showCreatePromotionModal()">
                            <i class="fas fa-plus"></i> Thêm Promotion
                        </button>
                    </div>
                </div>
                <div class="admin-card-body">
                    <form id="filterForm" class="mb-4" th:action="@{/promotions}" method="get">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px;">
                            <div class="form-group">
                                <label for="id"><i class="fas fa-hashtag" style="margin-right:6px;"></i>ID:</label>
                                <input type="text" id="id" name="id" class="form-control" th:value="${id}" placeholder="Tìm theo ID..." />
                            </div>
                            <div class="form-group">
                                <label for="name"><i class="fas fa-tag" style="margin-right:6px;"></i>Tên:</label>
                                <input type="text" id="name" name="name" class="form-control" th:value="${name}" placeholder="Tìm theo tên..." />
                            </div>
                            <div class="form-group">
                                <label for="isActive"><i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái:</label>
                                <select id="isActive" name="isActive" class="form-control">
                                    <option value="" th:selected="${isActive == null}">Tất cả</option>
                                    <option value="true" th:selected="${isActive == true}">Active</option>
                                    <option value="false" th:selected="${isActive == false}">Inactive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="search"><i class="fas fa-search" style="margin-right:6px;"></i>Tìm kiếm:</label>
                                <input type="text" id="search" name="search" class="form-control" th:value="${search}" placeholder="Nhập tên, mô tả hoặc id." />
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Lọc</button>
                            <button type="button" class="btn btn-secondary" onclick="resetPromotionsFilters()"><i class="fas fa-times"></i> Xóa bộ lọc</button>
                        </div>
                    </form>

                    <div class="table-loading-overlay" id="tableLoadingOverlay"><div class="loading-spinner"></div></div>
                    <div id="notificationContainer"></div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>
                                        <a class="text-decoration-none" th:href="@{/promotions(page=${currentPage}, size=${size}, sort='id', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">
                                            <i class="fas fa-hashtag" style="margin-right:6px;"></i>ID
                                            <i th:if="${sort == 'id'}" th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                        </a>
                                    </th>
                                    <th>
                                        <a class="text-decoration-none" th:href="@{/promotions(page=${currentPage}, size=${size}, sort='name', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">
                                            <i class="fas fa-tag" style="margin-right:6px;"></i>Tên
                                            <i th:if="${sort == 'name'}" th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                        </a>
                                    </th>
                                    <th><i class="fas fa-image" style="margin-right:6px;"></i>Thumbnail</th>
                                    <th><i class="fas fa-percent" style="margin-right:6px;"></i>Loại giảm giá</th>
                                    <th><i class="fas fa-dollar-sign" style="margin-right:6px;"></i>Giá trị</th>
                                    <th>
                                        <a class="text-decoration-none" th:href="@{/promotions(page=${currentPage}, size=${size}, sort='isActive', direction=${direction == 'asc' ? 'desc' : 'asc'}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">
                                            <i class="fas fa-toggle-on" style="margin-right:6px;"></i>Trạng thái
                                            <i th:if="${sort == 'isActive'}" th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                        </a>
                                    </th>
                                    <th class="text-center"><i class="fas fa-ellipsis-h" style="margin-right:6px;"></i>Hành động</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="p : ${promotions}" th:attr="data-promotion-id=${p.id}">
                                    <td th:text="${p.id}"></td>
                                    <td th:text="${p.name}"></td>
                                    <td>
                                        <img th:if="${p.thumbnailUrl}" th:src="${p.thumbnailUrl}" alt="thumb" class="thumb clickable-image" th:attr="data-image-url=${p.thumbnailUrl}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Crect fill=\'%23e6e6e6\' width=\'80\' height=\'80\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'12\'%3ENo Image%3C/text%3E%3C/svg%3E'; this.classList.add('img-error');" />
                                        <span th:if="${p.thumbnailUrl == null || p.thumbnailUrl.isEmpty()}">-</span>
                                    </td>
                                    <td>
                                        <span th:if="${p.discountType == 'DISCOUNT_AMOUNT'}" class="discount-badge discount-amount">
                                            <i class="fas fa-money-bill-wave"></i> Giảm giá
                                        </span>
                                        <span th:if="${p.discountType == 'GIFT'}" class="discount-badge discount-gift">
                                            <i class="fas fa-gift"></i> Tặng quà
                                        </span>
                                        <span th:if="${p.discountType == null}">-</span>
                                    </td>
                                    <td>
                                        <span th:if="${p.discountType == 'DISCOUNT_AMOUNT' && p.discountAmount != null}" th:text="${#numbers.formatDecimal(p.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                                        <span th:if="${p.discountType == 'GIFT' && p.giftItems != null && !p.giftItems.isEmpty()}" th:text="${#lists.size(p.giftItems)} + ' sản phẩm'"></span>
                                        <span th:if="${(p.discountType == 'DISCOUNT_AMOUNT' && (p.discountAmount == null || p.discountAmount == 0)) || (p.discountType == 'GIFT' && (p.giftItems == null || p.giftItems.isEmpty()))}">-</span>
                                    </td>
                                    <td>
                                        <span th:if="${p.isActive}" class="badge bg-success">Active</span>
                                        <span th:unless="${p.isActive}" class="badge bg-danger">Inactive</span>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-success btn-sm" title="Xem" th:onclick="'viewPromotion(' + ${p.id} + ')'">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-warning btn-sm" title="Sửa" th:onclick="'openEditPromotionModal(' + ${p.id} + ')'">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(promotions)}">
                                    <td colspan="7">Không có dữ liệu</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="page-size-selector">
                        <label for="pageSize">Hiển thị:</label>
                        <select id="pageSize" name="pageSize" onchange="changePageSize()">
                            <option value="5" th:selected="${size == 5}">5</option>
                            <option value="10" th:selected="${size == 10}">10</option>
                            <option value="20" th:selected="${size == 20}">20</option>
                            <option value="50" th:selected="${size == 50}">50</option>
                            <option value="100" th:selected="${size == 100}">100</option>
                        </select>
                        <span>kết quả/trang</span>
                    </div>

                    <div class="pagination">
                        <a th:if="${hasPrev}" th:href="@{/promotions(page=${currentPage - 1}, size=${size}, sort=${sort}, direction=${direction}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}"><i class="fas fa-chevron-left"></i> Trước</a>
                        <span th:text="${currentPage} + ' / ' + ${totalPages}"></span>
                        <a th:if="${hasNext}" th:href="@{/promotions(page=${currentPage + 1}, size=${size}, sort=${sort}, direction=${direction}, id=${id}, name=${name}, isActive=${isActive}, search=${search})}">Tiếp <i class="fas fa-chevron-right"></i></a>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Edit Promotion Modal -->
    <div id="editPromotionModal" class="modal" data-static="true">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Cập nhật Promotion</h3>
                <button class="modal-close" onclick="closeModal('editPromotionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editPromotionForm">
                    <input type="hidden" id="editId" />
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editName">Tên *</label>
                            <input id="editName" class="form-control" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="editDiscountType">Loại giảm giá *</label>
                            <select id="editDiscountType" class="form-control" required>
                                <option value="">Chọn loại...</option>
                                <option value="DISCOUNT_AMOUNT">Giảm giá</option>
                                <option value="GIFT">Tặng quà</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="editDiscountAmountGroup" style="display:none;">
                            <label for="editDiscountAmount">Số tiền giảm (VNĐ) *</label>
                            <input id="editDiscountAmount" class="form-control" type="number" step="0.01" min="0" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">Mô tả</label>
                        <textarea id="editDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editThumbnailUrl">Thumbnail</label>
                        <div class="upload-url-input-container">
                            <input id="editThumbnailUrl" class="form-control upload-url-input" type="text" placeholder="Nhập URL ảnh hoặc upload bên dưới" />
                        </div>
                        <div class="upload-area" onclick="triggerFileInput(this)" data-edit-mode="true">
                            <i class="fas fa-cloud-upload-alt upload-area-icon"></i>
                            <div class="upload-area-text">Kéo thả ảnh vào đây hoặc click để chọn</div>
                            <div class="upload-area-hint">JPG, PNG, WEBP, AVIF - tối đa 5MB</div>
                            <input type="file" id="editThumbnailUrlFile" class="upload-area-file-input" accept="image/jpeg,image/png,image/webp,image/avif" onchange="handleEditPromotionThumbnailUpload(this)" />
                        </div>
                        <div class="upload-progress-container" id="editPromotionProgressContainer">
                            <div class="upload-progress-label">
                                <span>Đang upload ảnh...</span>
                                <span class="upload-progress-percent">0%</span>
                            </div>
                            <div class="upload-progress-bar"><div class="upload-progress-fill"></div></div>
                        </div>
                        <div id="editThumbnailUrlPreviewContainer" class="upload-preview-container"></div>
                    </div>
                    <div class="form-group" id="editConditionsGroup">
                        <label>Điều kiện áp dụng *</label>
                        <div id="editConditionsContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addEditConditionGroup()">
                            <i class="fas fa-plus"></i> Thêm nhóm điều kiện
                        </button>
                    </div>
                    <div class="form-group" id="editGiftItemsGroup" style="display:none;">
                        <label>Sản phẩm tặng kèm *</label>
                        <div id="editGiftItemsContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addEditGiftItem()">
                            <i class="fas fa-plus"></i> Thêm sản phẩm tặng
                        </button>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editIsActive" /> Kích hoạt
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editPromotionModal')">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitUpdatePromotion()">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Create Promotion Modal -->
    <div id="createPromotionModal" class="modal" data-static="true">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Thêm Promotion</h3>
                <button class="modal-close" onclick="closeModal('createPromotionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createPromotionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="createName">Tên *</label>
                            <input id="createName" class="form-control" type="text" required />
                            <div class="error-message" id="createNameError"></div>
                        </div>
                        <div class="form-group">
                            <label for="createDiscountType">Loại giảm giá *</label>
                            <select id="createDiscountType" class="form-control" required>
                                <option value="">Chọn loại...</option>
                                <option value="DISCOUNT_AMOUNT">Giảm giá</option>
                                <option value="GIFT">Tặng quà</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="createDiscountAmountGroup" style="display:none;">
                            <label for="createDiscountAmount">Số tiền giảm (VNĐ) *</label>
                            <input id="createDiscountAmount" class="form-control" type="number" step="0.01" min="0" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="createDescription">Mô tả</label>
                        <textarea id="createDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="createThumbnailUrl">Thumbnail</label>
                        <div class="upload-url-input-container">
                            <input id="createThumbnailUrl" class="form-control upload-url-input" type="text" placeholder="Nhập URL ảnh hoặc upload bên dưới" />
                        </div>
                        <div class="upload-area" onclick="triggerFileInput(this)" data-create-mode="true">
                            <i class="fas fa-cloud-upload-alt upload-area-icon"></i>
                            <div class="upload-area-text">Kéo thả ảnh vào đây hoặc click để chọn</div>
                            <div class="upload-area-hint">JPG, PNG, WEBP, AVIF - tối đa 5MB</div>
                            <input type="file" id="createThumbnailUrlFile" class="upload-area-file-input" accept="image/jpeg,image/png,image/webp,image/avif" onchange="handlePromotionThumbnailUpload(this)" />
                        </div>
                        <div class="upload-progress-container" id="createPromotionProgressContainer">
                            <div class="upload-progress-label">
                                <span>Đang upload ảnh...</span>
                                <span class="upload-progress-percent">0%</span>
                            </div>
                            <div class="upload-progress-bar"><div class="upload-progress-fill"></div></div>
                        </div>
                        <div id="createThumbnailUrlPreviewContainer" class="upload-preview-container"></div>
                    </div>
                    <div class="form-group" id="createConditionsGroup">
                        <label>Điều kiện áp dụng *</label>
                        <div id="createConditionsContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addCreateConditionGroup()">
                            <i class="fas fa-plus"></i> Thêm nhóm điều kiện
                        </button>
                    </div>
                    <div class="form-group" id="createGiftItemsGroup" style="display:none;">
                        <label>Sản phẩm tặng kèm *</label>
                        <div id="createGiftItemsContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addCreateGiftItem()">
                            <i class="fas fa-plus"></i> Thêm sản phẩm tặng
                        </button>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="createIsActive" checked> Kích hoạt
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createPromotionModal')">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitCreatePromotion()">Thêm</button>
            </div>
        </div>
    </div>

    <!-- Drawer chi tiết Promotion -->
    <div id="promotionDrawer" class="drawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3 class="drawer-title"><i class="fas fa-gift" style="margin-right:8px;"></i>Chi tiết Promotion</h3>
                <button class="modal-close" onclick="closeDrawer('promotionDrawer')">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="desc-section">
                    <h4 class="desc-section-title">Thông tin cơ bản</h4>
                    <div class="desc-grid">
                        <div class="desc-label">ID</div><div class="desc-value" id="viewPromoId">-</div>
                        <div class="desc-label">Tên</div><div class="desc-value" id="viewPromoName">-</div>
                        <div class="desc-label">Loại giảm giá</div><div class="desc-value" id="viewPromoDiscountType">-</div>
                        <div class="desc-label">Giá trị</div><div class="desc-value" id="viewPromoDiscountValue">-</div>
                        <div class="desc-label">Mô tả</div><div class="desc-value" id="viewPromoDescription">-</div>
                        <div class="desc-label">Trạng thái</div><div class="desc-value" id="viewPromoActive">-</div>
                    </div>
                </div>
                <div class="desc-section">
                    <h4 class="desc-section-title">Hiển thị</h4>
                    <div class="desc-grid">
                        <div class="desc-label">Thumbnail</div>
                        <div class="desc-value">
                            <div id="viewPromoThumbSkeleton" class="skeleton skeleton-lg" style="display:none;"></div>
                            <img id="viewPromoThumb" class="thumb clickable-image" alt="thumb" style="display:none;cursor:pointer;" />
                            <div id="viewPromoThumbEmpty" class="empty-state" style="display:none;">Không có dữ liệu</div>
                        </div>
                    </div>
                </div>
                <div class="desc-section" id="viewPromoConditionsSection">
                    <h4 class="desc-section-title">Điều kiện áp dụng</h4>
                    <div id="viewPromoConditionsContainer"></div>
                </div>
                <div class="desc-section" id="viewPromoGiftItemsSection" style="display:none;">
                    <h4 class="desc-section-title">Sản phẩm tặng kèm</h4>
                    <div id="viewPromoGiftItemsContainer"></div>
                </div>
            </div>
            <div class="drawer-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDrawer('promotionDrawer')">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="image-preview-modal">
        <div class="image-preview-content">
            <button class="image-preview-close" onclick="closeImagePreview()">&times;</button>
            <img id="previewImage" src="" alt="Preview" />
        </div>
    </div>
</body>
</html>

